- name: Copy SAW Transport Service package
  copy: src="{{ item }}" dest=/tmp/saw-transport.rpm
  with_fileglob: ["../rpms/saw-transport-*.rpm"]
- name: Install SAW Transport Service package
  yum: name=/tmp/saw-transport.rpm state=present
  notify:
    - restart saw-transport
    - restart saw-transport-executor-regular
    - restart saw-transport-executor-fast
- name: Install SAW Transport Service configuration file
  template: src=application.conf dest=/opt/saw/service/conf
  notify:
    - restart saw-transport
    - restart saw-transport-executor-regular
    - restart saw-transport-executor-fast
- name: Create Transport Service environment file
  file: path=/etc/bda/saw-transport-service-env state=touch
# Workaround: The service restart handler will run only after all
# tasks have completed.  This causes the service to remain running
# using the old port when the new socket activation proxy starts up,
# resulting in a port already in use error.  So trigger the restart
# handler already here, to force the service to pick up the new port
# setting before starting the socket activation proxy.  Can be removed
# as no longer needed after the next SAW release.
- meta: flush_handlers
- name: Run SAW migration of Semantic id
  command: sh /opt/saw/service/bin/AnalysisUtility.sh
- name: Enable SAW Transport Service
  systemd: name=saw-transport-proxy.socket enabled=true state=started
- name: Enable SAW Transport Service Executor (regular)
  systemd: name="saw-transport-executor@regular-{{ item }}" enabled=true daemon_reload=true
  with_sequence: count={{ saw_transport_executor_regular_count | default('1') }}
- name: Enable SAW Transport Service Executor (fast)
  systemd: name="saw-transport-executor@fast-{{ item }}" enabled=true daemon_reload=true
  with_sequence: count={{ saw_transport_executor_fast_count | default('1') }}
