<?xml version="1.0" encoding="UTF-8"?>
<project xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <modelVersion>4.0.0</modelVersion>
  <groupId>com.synchronoss.saw</groupId>
  <artifactId>saw</artifactId>
  <version>${revision}</version>
  <packaging>pom</packaging>
  <name>saw</name>
  <properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  </properties>
  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>4.12</version>
        <scope>test</scope>
    </dependency>
    </dependencies>
  </dependencyManagement>
  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-enforcer-plugin</artifactId>
        <version>3.0.0-M1</version>
        <configuration>
          <skip>true</skip>
          <rules>
          </rules>
        </configuration>
      </plugin>
      <!-- Workaround: When activating "docker-start" profile, the
           "docker:build" goal will be invoked on the top-level
           project too, so ensure the plug-in exists with an empty
           configuration to let the build proceed.  -->
      <plugin>
        <groupId>io.fabric8</groupId>
        <artifactId>docker-maven-plugin</artifactId>
        <version>0.24.0</version>
        <!-- Mark as not inherited to avoid propagating skip setting -->
        <inherited>false</inherited>
        <configuration>
          <!-- Skip execution of the Docker Maven plug-in for the
               parent project -->
          <skip>true</skip>
        </configuration>
      </plugin>
    </plugins>
    <pluginManagement>
      <plugins>
        <plugin>
          <groupId>org.apache.maven.plugins</groupId>
          <artifactId>maven-assembly-plugin</artifactId>
          <version>3.1.0</version>
        </plugin>
        <plugin> 
          <groupId>org.apache.maven.plugins</groupId>
          <artifactId>maven-failsafe-plugin</artifactId>
          <version>2.20.1</version>
        </plugin>
      </plugins>
    </pluginManagement>
  </build>
  <repositories>
    <repository>
      <id>synchronoss</id>
      <url>http://maven-us.synchronoss.net:8081/nexus/content/repositories/releases-only</url>
    </repository>
  </repositories>
  <profiles>
    <!-- Define modules in a default profile, instead of at the top
         level, to allow limiting modules built in different profiles.
         This allows for example an invocation to build and start a
         SAW development environment to be limited to the "dist"
         module. -->
    <profile>
      <id>default</id>
      <activation>
        <activeByDefault>true</activeByDefault>
      </activation>
      <modules>
        <module>saw-dist</module>
        <module>saw-security</module>
        <module>saw-services</module>
        <module>saw-web</module>
      </modules>
    </profile>
    <!-- Profile that uses the preset container name "saw" and binds
         to preset ports.  This is for developers who are manually
         interacting with the SAW containers and only running a single
         instance at a time.  The profile cannot be enabled by
         default, because the static container names and ports would
         prevent multiple Maven builds and integration tests from
         running in parallel, as can happen for example in continuous
         integration.  -->
    <profile>
      <id>docker-start</id>
      <activation>
        <property>
          <name>docker-start</name>
        </property>
      </activation>
      <modules>
        <module>saw-dist</module>
      </modules>
      <build>
        <defaultGoal>
          enforcer:enforce docker:stop docker:build docker:start
        </defaultGoal>
      </build>
      <properties>
        <saw.docker.port>80</saw.docker.port>
        <saw.docker.naming>alias</saw.docker.naming>
        <saw.mapr.port>18443</saw.mapr.port>
        <saw.spark.master.port>18080</saw.spark.master.port>
        <saw.spark.worker.port>18081</saw.spark.worker.port>
        <saw.kibana.port>15601</saw.kibana.port>
        <saw.journal.port>19531</saw.journal.port>
        <!-- Show Docker image build output by default to keep users
             up to date on the progress, as it can take considerable
             time for the first run and after Dockerfile modifications
             -->
        <docker.verbose>true</docker.verbose>
      </properties>
    </profile>
    <!-- Local Docker profile -->
    <profile>
      <id>docker-start-local</id>
      <activation>
        <property>
          <name>docker-start</name>
          <value>local</value>
        </property>
      </activation>
      <properties>
        <!-- Disable Docker Machine configuration when local -->
        <docker.skip.machine>true</docker.skip.machine>
        <!-- Limit access to local machine only by default -->
        <saw.docker.ip>localhost</saw.docker.ip>
      </properties>
    </profile>
    <!-- Cloud Docker profile -->
    <profile>
      <id>docker-start-cloud</id>
      <activation>
        <property>
          <name>docker-start</name>
          <value>cloud</value>
        </property>
      </activation>
      <properties>
        <!-- Enable Docker Machine configuration when using cloud -->
        <docker.skip.machine>false</docker.skip.machine>
        <!-- Bind to all interfaces so that environment can be
             accessed remotely -->
        <saw.docker.ip>0.0.0.0</saw.docker.ip>
      </properties>
      <build>
        <plugins>
          <!-- Enable Enforcer plug-in to ensure that required SAW_AWS_*
               environment variables have been set -->
          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-enforcer-plugin</artifactId>
            <version>3.0.0-M1</version>
            <configuration>
              <skip>false</skip>
              <rules>
                <requireProperty>
                  <property>env.SAW_AWS_REGION</property>
                  <message>The environment variable SAW_AWS_REGION must be set</message>
                  <regex>(us|in)</regex>
                  <regexMessage>Region must be one of the supported regions: "us" or "in"</regexMessage>
                </requireProperty>
                <requireProperty>
                  <property>env.SAW_AWS_ACCESS_KEY_ID</property>
                  <message>The environment variable SAW_AWS_ACCESS_KEY_ID must be set</message>
                </requireProperty>
                <requireProperty>
                  <property>env.SAW_AWS_SECRET_ACCESS_KEY</property>
                  <message>The environment variable SAW_AWS_SECRET_ACCESS_KEY must be set</message>
                </requireProperty>
                <requireProperty>
                  <property>env.SAW_AWS_USERNAME</property>
                  <message>The environment variable SAW_AWS_USERNAME must be set</message>
                  <regex>\w{4}\d{4}</regex>
                  <regexMessage>Username must be in the form "abcd0001"</regexMessage>
                </requireProperty>
              </rules>
              <fail>true</fail>
            </configuration>
          </plugin>
        </plugins>
      </build>
    </profile>
    <!-- Region-specific cloud Docker Machine profiles -->
    <profile>
      <id>docker-start-cloud-us</id>
      <activation>
        <property>
          <name>env.SAW_AWS_REGION</name>
          <value>us</value>
        </property>
      </activation>
      <properties>
        <saw.docker.machine.aws.region>us-east-1</saw.docker.machine.aws.region>
        <saw.docker.machine.aws.ami>ami-4bf3d731</saw.docker.machine.aws.ami>
      </properties>
    </profile>
    <profile>
      <id>docker-start-cloud-in</id>
      <activation>
        <property>
          <name>env.SAW_AWS_REGION</name>
          <value>in</value>
        </property>
      </activation>
      <properties>
        <saw.docker.machine.aws.region>ap-south-1</saw.docker.machine.aws.region>
        <saw.docker.machine.aws.ami>ami-5d99ce32</saw.docker.machine.aws.ami>
      </properties>
    </profile>
  </profiles>
</project>
