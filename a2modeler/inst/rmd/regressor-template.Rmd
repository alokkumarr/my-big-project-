---
title: "Regressor Template"
author: "Change Me"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = TRUE, message = FALSE,
                      fig.align = "center", fig.width = 9, fig.height = 5)
```

## Version Notes


```{r input-data-params, eval = FALSE}

## Input Data Parameters for reader function

# Path to dataset
dataset_path <- "CHANGEME"

# Name to assign to Data
dataset_name <- "df"

# Dataset type
dataset_type <- "CHANGEME"

```


```{r inputs, eval = FALSE}

### Regressor Configuration Inputs 

# target variable name
target <- "changeme"

# Optional Regressor name
name <- NULL

# Optional Regressor Unique ID
uid <- NULL

# Optional Regressor Version 
version <- NULL

# Optional Description of Regressor
desc <- NULL

# Optional Input for Data Scientist Author
scientist <- NULL

# Execution Strategy (sequential or multisession)
execution_strategy <- "sequential"

# Option to refit model on entire training and validation sample
refit <- TRUE

# Option to save sub-models used in tuning
save_submodels <- TRUE

# Optional random seed number
seed <- 319

```


```{r data-prep, eval = FALSE}

# Create a data prep pipeline. Applied to data prior to regressor creation
prep_pipe <- pipeline(expr = identity,
                      uid  = "Data-Prep-Pipe",
                      desc = "Data preperation pipeline. Applied before any modeling or feature generation is applied")

```


```{r regressor-creation, eval = FALSE}

# Create Regressor
r1 <- df %>% 
  flow(., prep_pipe) %>% 
  regressor(.,
            target,
            name = name,
            uid = uid,
            version = version,
            desc = desc,
            scientist = scientist,
            execution_strategy = execution_strategy,
            refit = refit,
            save_submodels = save_submodels,
            seed = seed)
```


```{r measure, eval = FALSE}

# Set Measure. RMSE is default
r1 <- set_measure(r1, RMSE)

```


```{r sampling, eval = FALSE}

# Set Sampling Method. Options include cross_validation, holdout, random or
# default
r1 <- add_holdout_samples(r1, splits = c(.6, .2, .2))

```


```{r feature-generation, eval = FALSE}

# Create one or more feature generation pipelines. Each can be applied in one or
# more models
feature_pipe1 <- pipeline(expr = identity,
                          uid  = "Feature-Pipe-1",
                          desc = "")

```


```{r models, eval = FALSE}

# Add Regression Models
r1 <- r1 %>% 
  add_model(., 
            method = "ml_linear_regression",
            pipe = feature_pipe1,
            param_map = list(standardization = TRUE),
            uid = "linear-baseline",
            desc = "Simple linear model to create baseline prediction accuracy")
```


```{r train-models, eval = FALSE}

# Train models
r1 <- train_models(r1)

```


```{r set-final, eval = FALSE}

# Set Final Model 
r1 <- set_final_model(r1, "best", reevaluate = TRUE, refit = TRUE)
```



```{r r-config, eval = FALSE}

# Library Path
lib_path <- .libPaths()[1]

# R packages
packages <- c("a2munge", "a2modeler", "a2charter", "sparklyr", "dplyr", "purrr", "ggplot2")


```


```{r spark-config, eval = FALSE}

## Spark Configuration Parameters

# Create Spark Connection
spark <- TRUE

# Spark Master
spark_master <- "local"

# Spark Version
spark_version <- "2.3.0"

# Additional Spark Configuration Settings. Add configuration with named element
# in list
spark_config_args <- list(spark.memory.fraction = 0.9)

```


```{r r-setup, eval = FALSE}

# Load Libraries
for(pck in packages) library(pck, lib.loc = lib_path, character.only = TRUE)

```


```{r spark-setup, eval = FALSE}

# If Spark Option True, create connection
if(spark) {
  
  conf <- modifyList(spark_config(), spark_config_args)
  sc <- spark_connect(master = spark_master,
                      version = spark_version,
                      config = conf)
}
```


```{r data-import, eval = FALSE}

# Read data into memory
if(spark) {
  df <- reader(sc, name = dataset_name, path = dataset_path, type = dataset_type)
} else {
  df <- read.csv(dataset_path)
}

```


```{r execution, ref.label=c('r-config', 'r-setup', 'spark-config', 'spark-setup', 'input-data-params', 'data-import', 'data-pred',  'inputs', 'regressor-creation', 'measure', 'sampling', 'feature-generation', 'models', 'train-model', 'set-final')}

```

## Regressor Configuration

```{r regressor-config, echo=TRUE, eval=FALSE, ref.label=c('inputs', 'regressor-creation', 'measure', 'sampling', 'feature-generation', 'models', 'train-model', 'set-final')}

```


## Regressor Result

```{r regressor-final}
print(r1)
```


## Appendix

```{r config, echo=TRUE, eval=FALSE, ref.label=c('r-config', 'spark-config')}

```