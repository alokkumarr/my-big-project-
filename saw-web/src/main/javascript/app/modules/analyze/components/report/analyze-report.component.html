<analyze-dialog control="$ctrl" class="analyze-report-dialog">
  <analyze-dialog-header>
    <div layout="row">
      <md-button class="ard_back-btn"
                 ng-click="$ctrl.goBack()">
        <md-icon md-font-icon="icon-arrow-left"></md-icon>
      </md-button>

      <div class="ard_meta" flex>
        <div class="md-title">
          <strong class="e2e-report-title" ng-bind="$ctrl.model.name"></strong>
          <label translate="DRAFT" ng-show="$ctrl.draftMode"></label>
        </div>
        <div class="md-description">
          <md-icon md-font-icon="icon-report"></md-icon>
          <span ng-bind="::$ctrl.model.metricName"></span>
        </div>
      </div>

      <div class="ard_actions" flex>
        <md-button ng-click="$ctrl.openSaveReportModal($event)"
                   e2e="open-save-modal"
                   translate="SAVE">
        </md-button>
      </div>
    </div>
    <md-progress-linear ng-show="$ctrl.showProgress" md-mode="indeterminate"></md-progress-linear>
  </analyze-dialog-header>

  <analyze-dialog-content>

    <div layout="column">
      <div class="ard_content" layout="column">
        <div layout="row" class="ard_sub-header">
          <span ng-if="$ctrl.states.sqlMode === $ctrl.DESIGNER_MODE"
                translate="CHOOSE_FIELDS_TO_SHOW_IN_YOUR_REPORT">
          </span>

          <span ng-if="$ctrl.states.sqlMode === $ctrl.QUERY_MODE"
                translate="SQL_QUERY">
          </span>

          <div>
            <md-button ng-class="{'m-active': $ctrl.states.sqlMode === $ctrl.DESIGNER_MODE}"
                       class="mode-selector"
                       ng-if="$ctrl.supportsQuery()"
                       ng-disabled="$ctrl.states.disable.designer || $ctrl.model.edit"
                       ng-click="$ctrl.setSqlMode($ctrl.DESIGNER_MODE)">
              <md-icon md-font-icon="icon-designer-mode"></md-icon>
              <span translate="DESIGNER"></span>
            </md-button>

            <md-button ng-class="{'m-active': $ctrl.states.sqlMode === $ctrl.QUERY_MODE}"
                       class="mode-selector"
                       ng-if="$ctrl.supportsQuery()"
                       ng-click="$ctrl.setSqlMode($ctrl.QUERY_MODE)">
              <md-icon md-font-icon="icon-query-mode"></md-icon>
              <span translate="QUERY"></span>
            </md-button>

            <md-button ng-click="$ctrl.openDescriptionModal($event, $ctrl.model)"
                      e2e="open-description-modal">
              <md-icon md-font-icon="icon-description"></md-icon>
              <span translate="DESCRIPTION"></span>
            </md-button>

            <md-button ng-if="!$ctrl.model.edit"
                       ng-show="$ctrl.states.sqlMode === $ctrl.DESIGNER_MODE"
                       ng-click="$ctrl.openFiltersModal($event)"
                       e2e="open-filter-modal">
              <md-icon md-font-icon="icon-filter"></md-icon>
              <span translate="FILTER"></span>
            </md-button>
          </div>
        </div>

        <div layout="row" class="ard_canvas">
          <div ng-show="$ctrl.states.sqlMode === $ctrl.DESIGNER_MODE">
            <js-plumb-canvas id="ard-canvas" did-analysis-change="$ctrl.didAnalysisChange" on-change="$ctrl.updateJoins(name, params)"></js-plumb-canvas>
          </div>

          <div class="ard_canvas-query"
               ng-show="$ctrl.states.sqlMode === $ctrl.QUERY_MODE">
            <analyze-report-query [model]="$ctrl.model"
                                  [artifacts]="$ctrl.artifacts"
                                  (on-query-change)="$ctrl.startDraftMode()"
                                  (on-save)="$ctrl.onSaveQuery($event)">
            </analyze-report-query>
          </div>
        </div>
      </div>

      <div layout="row" class="ard_toolbar">
        <md-button class="ard_toolbar-expand"
                   e2e="report-expand-btn"
                   ng-class="{'m-expanded':$ctrl.states.detailsExpanded}"
                   ng-click="$ctrl.toggleDetailsPanel()">
          <md-icon md-font-icon="icon-expand"></md-icon>
        </md-button>

        <span class="ard_toolbar-text"
              e2e="designer-type-report"
              translate="REPORT"></span>

        <div class="ard_toolbar-actions" flex>
          <md-button ng-click="$ctrl.onRefreshData()"
                     e2e="refresh-data-btn"
                     ng-if="!$ctrl.model.edit"
                     ng-show="$ctrl.states.sqlMode === $ctrl.DESIGNER_MODE"
                     ng-class="{'btn-primary': $ctrl.didAnalysisChange}" >
            <span translate="REFRESH_DATA"></span>
          </md-button>

          <md-button ng-click="$ctrl.openReportPreviewModal($event)"
                     e2e="open-preview-modal"
                     ng-disabled="$ctrl.isPreviewDisabled()">
            <md-icon md-font-icon="icon-full-screen"></md-icon>
            <span translate="PREVIEW"></span>
          </md-button>

          <md-button ng-click="$ctrl.openReportSortModal($event)"
                     e2e="open-sort-modal"
                     ng-if="!$ctrl.model.edit"
                     ng-show="$ctrl.states.sqlMode === $ctrl.DESIGNER_MODE"
                     ng-disabled="$ctrl.isSortDisabled()">
            <md-icon md-font-icon="icon-sort"></md-icon>
            <span translate="SORT"></span>
          </md-button>
        </div>
      </div>

      <div layout="column" class="ard_details-panel"
           ng-if="$ctrl.states.detailsExpanded">
        <div layout="column" class="ard_details-panel-empty"
             ng-show="!$ctrl.hasSelectedColumns()">
          <span translate="CHOOSE_FIELDS_ABOVE_TO_PREVIEW_YOUR_REPORT"></span>
          <md-icon md-font-icon="icon-report"></md-icon>
        </div>

        <filter-chips filters="$ctrl.filters"
                      on-clear-all-filters="$ctrl.onClearAllFilters()"
                      on-filter-removed="$ctrl.onFilterRemoved(index)">
        </filter-chips>

        <report-grid-container id="ard-grid-container" layout="row"
                               event-emitter="$ctrl.canvas._$eventEmitter"
                               columns="$ctrl.columns"
                               show-group-panel="true"
                               show-view-more="true"
                               ng-show="$ctrl.gridData.length">
        </report-grid-container>
        <div class="data-count-limit" ng-if="$ctrl.gridData.length">
          Showing {{$ctrl.gridData.length}} out of {{$ctrl.gridDataTotalCount}} rows. Click on 'Preview' to see more.
        </div>
      </div>
    </div>
  </analyze-dialog-content>
</analyze-dialog>
