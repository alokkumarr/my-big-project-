#!/bin/sh
#
# Deploy SAW to an environment
#
set -eu

if [ $# -ne 1 ]; then
    echo "Usage: $0 <config>"
    exit 1
fi

config=$1
dir=$(dirname $0)

yum_install() {
    sudo yum -q -y install $*
}

# Install deployment tools, if not already installed
if ! command -v ansible-playbook > /dev/null; then
    echo "Installing deployment tools"
    # Workaround: Ansible is not available from the default
    # repositories yet, so install it from EPEL for now.  RHEL might
    # not provide epel-release, so install it directly from URL.
    pkg=epel-release-latest-7.noarch.rpm
    url=https://dl.fedoraproject.org/pub/epel/$pkg
    yum_install $url
    yum_install ansible
fi

# Workaround: Ansible version 2.4 has deprecated using the "include"
# directive for importing playbooks, so it has been changed to
# "import_playbook".  However, there are still some environments on
# older Ansible versions, so include a workaround for them by
# modifying "site.yml" to use the old approach.  Remove when all
# environments have upgraded to Ansible 2.4 or newer.
set -o pipefail
if rpm -q ansible | grep -E "ansible-2.(2|3)" > /dev/null; then
    sed -i -e "s/^- import_playbook:/- include:/" $dir/site.yml
fi

echo "Starting deployment"
ansible-playbook -i $config $dir/site.yml
echo "Finished deployment"
