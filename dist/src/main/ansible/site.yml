# Note: Order according to dependencies, to ensure health checks
# can succeed right after installation
- name: SAW Host
  hosts: all
  become: true
  roles:
    - saw-host
    - sip-prometheus-node

- name: Admin
  hosts: sip-admin
  become: true
  roles:
    - { role: sip-ssl-certificate, when: sip_secure }

- name: SAW Services
  hosts: saw-services
  become: true
  tasks:
    - name: copying the certificates to the saw-services nodes
      copy:
        src: "{{ inventory_dir }}/certificate/self-signed-admin.crt"
        dest: /etc/bda/{{ ansible_host }}-certificate.crt
      when: sip_secure

    - name: copying the private to the saw-services nodes
      copy:
        src: "{{ inventory_dir }}/certificate/main-private.pem"
        dest: /etc/bda/{{ ansible_host }}-key.pem
      when: sip_secure

- import_playbook: modules/saw-security/ansible/site.yml
- import_playbook: modules/saw-services/ansible/site.yml
- import_playbook: modules/saw-web/ansible/site.yml
- import_playbook: modules/sip-xdf/ansible/site.yml
- import_playbook: modules/sip-a2/ansible/site.yml
- import_playbook: modules/sip-rtis/ansible/site.yml
- import_playbook: modules/sip-rtps/ansible/site.yml
# Note: Keep Prometheus at the end to avoid starting socket-activated
# services during metrics collection until all Ansible handlers have
# been run (which might otherwise cause unnecessary restarts of
# services and slow down deployment)
- name: Admin
  hosts: sip-admin
  become: true
  roles:
    - sip-prometheus
- name: SAW Proxy
  hosts: saw-proxy
  become: true
  roles:
    - saw-proxy
- name: Mariadb Prometheus
  hosts: saw-security
  become: true
  roles:
    - sip-mariadb-exporter
