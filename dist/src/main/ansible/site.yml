# Note: Order according to dependencies, to ensure health checks
# can succeed right after installation
- name: SAW Host
  hosts: all
  become: true
  roles:
    - saw-host
    - sip-prometheus-node
- import_playbook: modules/saw-security/ansible/site.yml
- import_playbook: modules/saw-services/ansible/site.yml
- import_playbook: modules/saw-web/ansible/site.yml
- import_playbook: modules/sip-xdf/ansible/site.yml
- import_playbook: modules/sip-a2/ansible/site.yml
- import_playbook: modules/sip-rtis/ansible/site.yml
- import_playbook: modules/sip-rtps/ansible/site.yml
# Note: Keep Prometheus at the end to avoid starting socket-activated
# services during metrics collection until all Ansible handlers have
# been run (which might otherwise cause unnecessary restarts of
# services and slow down deployment)
- name: Admin
  hosts: sip-admin
  become: true
  roles:
    - sip-prometheus
- name: SAW Proxy
  hosts: saw-proxy
  become: true
  roles:
    - saw-proxy
# Workaround: The Semantic Service binary to JSON migration at service
# startup fails silently.  Restarting the service seems to allow the
# migration to succeed on a second attempt.  So add a restart at the
# end of deployment as a temporary fix.  Remove this when the
# migration has been properly fixed to succeed on the first
# attempt. (SIP-6061)
- name: Restart Semantic Service for binary to JSON migration
  hosts: saw-services
  become: true
  tasks:
    - name: Restart SAW Semantic Service
      systemd: name=saw-semantic state=stopped daemon_reload=true
      register: result
      until: result is success
      delay: 30
