global
  log /dev/log local0
  # Allow large HTTP request headers, matching saw-proxy.conf
  tune.bufsize 65536

defaults
  log global
  mode http
  option httplog
  timeout connect 5s
  # Note: Timeouts raised above typical defaults for long-living HTTP
  # requests related to synchronous query execution
  timeout client 600s
  timeout server 600s
  errorfile 503 /etc/haproxy/errors/503.http
  stats enable
  stats uri  /haproxy

frontend sip_proxy
  bind *:80
  # Workaround: Rewrite requests for "/<module>" to "/saw/<module>"
  # for backward compatibility with clients from older branches during
  # a transition period.  Can be removed after all branches have been
  # updated to contain the URL path changes.
  reqrep ^([^\ :]*)\ /security/(.*)  \1\ /saw/security/\2
  reqrep ^([^\ :]*)\ /services/(.*)  \1\ /saw/services/\2
  reqrep ^([^\ :]*)\ /web/(.*)  \1\ /saw/web/\2
  # End workaround
  acl saw_web path_beg /saw/web/
  acl saw_services path_beg /saw/services/
  acl saw_security path_beg /saw/security/
  use_backend sip_saw_web if saw_web
  use_backend sip_saw_services if saw_services
  use_backend sip_saw_security if saw_security
  default_backend sip_root
  
backend sip_saw_web
  reqrep ^([^\ :]*)\ /saw/web/(.*)  \1\ /saw/\2
{% for host in groups['saw-web'] %}
  server {{ host }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:8080 check
{% endfor %}

backend sip_saw_services
  reqrep ^([^\ :]*)\ /saw/services/(.*)  \1\ /\2
  option httpchk GET /actuator/health
  default-server inter 10s
{% for host in groups['saw-services'] %}
  # Workaround: Turn off the recently added Gateway Service health
  # check (see the commented out "check" below), as the frequent
  # periodic connections seem to trigger leaking of file descriptors
  # somewhere upstream that eventually lead to connection errors after
  # a couple of hours.  Fixing this and reenabling the health check is
  # tracked in SIP-4851.
  server {{ host }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:9100 #check
{% endfor %}

backend sip_saw_security
  reqrep ^([^\ :]*)\ /saw/security/(.*)  \1\ /saw-security/\2
  option httpchk GET /saw-security/actuator/health
{% for host in groups['saw-security'] %}
  server {{ host }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:9000 check
{% endfor %}

backend sip_root
  acl saw_root path_reg ^/saw/?$
  http-request redirect location /saw/web/ if saw_root
  server localhost 127.0.0.1:8900
